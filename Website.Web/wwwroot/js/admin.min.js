function getItemCountFromHeight(){if(window.innerWidth<768)return 5;var t=window.innerHeight,n=Math.round((t-400)/65);return n<5?5:n}function validateAndSubmitJson(){var u=$("#edit-form").validate().valid(),t,n,r,i;u&&(t=$("#edit-form").serializeArray(),console.log(t),n=t.reduce(function(n,t){return n[t.name]=t.value,n},{}),r=n.__RequestVerificationToken,delete n.__RequestVerificationToken,n.Price=n.Price.replace(",","."),n.Images=getImagesData(),n.Categories=getCategoriesData(),n.Descriptions=getDescriptionsData(),console.log(n),i=JSON.stringify(n),console.log(i),console.log("sending json"),$.ajax({type:"POST",url:"/Admin/EditItem",headers:{RequestVerificationToken:r,"Content-Type":"application/json"},data:i,beforeSend:function(){$("button#edit-form-submit").prop("disabled",!0);$("span#edit-form-submit-icon").removeClass("fa-check").addClass("fa-spinner fa-spin")},success:function(n){$("div#admin-content").html(n);$.validator.unobtrusive.parse("form#edit-form");$("#category-select").selectpicker("refresh");$("#desc-group-select").selectpicker("refresh")},error:function(n){document.open();document.write(n.responseText);document.close()}}))}function getImagesData(){var u=$("div#image-container"),t,r,n,i;if(u.length===0)return null;for(t=[],r=u.children(),n=0;n<r.length;n++)i=r[n],t[n]={Id:i.dataset.id,Primary:i.classList.contains("img-primary")},i.classList.contains("img-add")?(t[n].DtoState="added",t[n].DataUrl=i.src):(t[n].DtoState=i.classList.contains("img-delete")?"deleted":"unchanged",t[n].Path=i.dataset.path,t[n].ThumbPath=i.getAttribute("src"));return t}function getCategoriesData(){var r=$(".category"),t,n,i;if(r.length===0)return null;for(t=[],n=0;n<r.length;n++)i=$(r[n]),t[n]={Id:i.data("id"),Name:i.children(".category-name").text(),Description:i.children(".category-desc").text()},t[n].Description=t[n].Description.slice(1,t[n].Description.length-1),t[n].DtoState=i.hasClass("cat-add")?"added":i.hasClass("cat-delete")?"deleted":"unchanged";return t}function getDescriptionsData(){}function generateImgId(){function n(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function setPrimaryImage(){var i=$("img.admin-img-thumb"),t,n;i.length!==0&&(t=$("img#admin-image-view"),$(".img-primary").each(function(n,t){t.classList.remove("img-primary")}),n=$(".admin-img-thumb[data-id="+t.data("id")+"]"),n.addClass("img-primary").removeClass("img-delete"),setImage(n))}function setDeleteImage(){var t=$("img.admin-img-thumb"),r,f,u;if(t.length!==0){var i=$("img#admin-image-view"),e=i.data("id"),n=$(".admin-img-thumb[data-id="+e+"]");if(n.hasClass("img-delete"))n.removeClass("img-delete"),i.removeClass("img-delete"),$(".admin-img-thumb.img-primary").length===0&&(n.addClass("img-primary"),i.removeClass("img-primary"));else if(r=n.hasClass("img-add"),r?(n.remove(),f=$("img.admin-img-thumb"),f.length===0?$("img#admin-image-view").attr("src",""):setImage($(".img-primary"))):(n.addClass("img-delete"),i.addClass("img-delete")),n.hasClass("img-primary")){n.removeClass("img-primary");i.removeClass("img-primary");u=0;t=$("img.admin-img-thumb");do n=$(t[u++]);while(n.hasClass("img-delete")&&t.length>u);if(n.hasClass("img-delete")){r&&setImage(t.first());return}n.addClass("img-primary");r&&setImage(n)}}}function setImage(n){var t,r,i;t=n.target?$(n.target):$(n);r=t.attr("src");i=$("img#admin-image-view").first();t.attr("src").substring(0,10)!=="data:image"&&(r=t.data("path"));i.attr("src",r);i.data("id",t.data("id"));t.hasClass("img-primary")?i.addClass("img-primary"):i.removeClass("img-primary");t.hasClass("img-delete")?i.addClass("img-delete"):i.removeClass("img-delete")}function loadCategoriesDropdown(){var n;$.ajax({type:"GET",url:"/AdminApi/Categories",beforeSend:function(){n=$("<div>",{id:"cat-loading","class":"text-center mt-1",text:"Загрузка"}).append($("<span>",{"class":"fa fa-spinner fa-spin ml-2"}));$(".bootstrap-select>.category-btn+.dropdown-menu>.inner").prepend(n)},success:function(t){t.forEach(function(n){$("#category-select").append($("<option>",{value:n.id,"data-subtext":n.description,text:n.name}))});n.remove();$("#category-select").selectpicker("refresh")},error:function(){$("#cat-loading").html("Ошибка загрузки")}})}function addCategory(){var n=$("#category-select"),i=n.val()===""?-1:n.val(),t=$(".category[data-id="+i+"]");if($("#category-select").val()===""||t.length){if(t.hasClass("cat-delete")){t.removeClass("d-none cat-delete");$("#categories").append(t);return}$("#category-select+.dropdown-toggle").fadeIn(100).fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100);return}var u=n.find("option:selected").text(),f=n.find("option:selected").data().subtext,e=$("<span>",{"class":"category-name",text:u}),o=$("<span>",{"class":"category-desc text-muted",text:"("+f+")"}),s=$("<span>",{"class":"remove-cat btn-pushy btn btn-outline-danger fa fa-close"}),r=$("<div>",{"class":"category cat-add","data-id":i}).append([e,o,s]);r.children().after(" ");$("#categories").append(r)}function removeCategory(){var t=$(this),n=t.parent();n.hasClass("cat-add")?n.remove():n.addClass("d-none cat-delete")}function loadDescGroupDropdown(){var n;$.ajax({type:"GET",url:"/AdminApi/DescriptionGroups",beforeSend:function(){n=$("<div>",{id:"desc-group-loading","class":"text-center mt-1",text:"Загрузка"}).append($("<span>",{"class":"fa fa-spinner fa-spin ml-2"}));$(".bootstrap-select>.desc-group-btn+.dropdown-menu>.inner").prepend(n)},success:function(t){t.forEach(function(n){$("#desc-group-select").append($("<option>",{value:n.id,"data-subtext":n.description,text:n.name}))});n.remove();$("#desc-group-select").selectpicker("refresh")},error:function(){$("#desc-group-loading").html("Ошибка загрузки")}})}function addDescGroup(){var t=$("#desc-group-select"),u=t.val()===""?-1:t.val(),i=$(".desc-group[data-id="+u+"]"),r;if($("#desc-group-select").val()===""||i.length){if(i.hasClass("desc-group-delete")){i.removeClass("d-none desc-group-delete");$("#desc-groups").append(i);return}$("#desc-group-select+.dropdown-toggle").fadeIn(100).fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100);return}var f=t.find("option:selected").text(),e=t.find("option:selected").data().subtext,n="";n+='<div class="desc-group my-2 desc-group-add" data-id="'+u+'">';n+="    <div>";n+='        <span class="desc-group-name h6">'+f+"<\/span>";n+='        <span class="desc-group-desc text-muted">'+e+"<\/span>";n+='        <span class="remove-desc-group btn-pushy btn btn-outline-danger btn-sm fa fa-close mb-1"><\/span>';n+="        <div>";n+='            <select id="desc-group-items-select" class="selectpicker" hidden data-live-search="true" data-live-search-normalize="true" data-live-search-style="contains"';n+='                    data-style="btn-outline-primary desc-group-items-btn p-1" data-width="fit" title="Добавить описание" data-live-search-placeholder="Поиск"><\/select>';n+='            <span class="add-desc-group-item btn-pushy btn btn-outline-success fa fa-check"><\/span>';n+="        <\/div>";n+="    <\/div>";n+='    <div id="desc-group-items">';n+="    <\/div>";n+="<\/div>";r=$.parseHTML(n);$("#desc-groups").append(r);$(r).find("#desc-group-items-select").selectpicker("refresh")}function removeDescGroup(){var t=$(this),n=t.closest("div.desc-group");n.hasClass("desc-group-add")?n.remove():n.addClass("d-none desc-group-delete")}function loadDescGroupItemsDropdown(){var t,n=$(this).closest(".desc-group"),i=n.data("id");$.ajax({type:"GET",url:"/AdminApi/DescriptionItems/"+i,beforeSend:function(){t=$("<div>",{id:"desc-group-items-loading","class":"text-center mt-1",text:"Загрузка"}).append($("<span>",{"class":"fa fa-spinner fa-spin ml-2"}));n.find(".bootstrap-select>.desc-group-items-btn+.dropdown-menu>.inner").prepend(t)},success:function(i){i.forEach(function(t){n.find("#desc-group-items-select").append($("<option>",{value:t.id,text:t.name}))});t.remove();n.find("#desc-group-items-select").selectpicker("refresh")},error:function(){n.find("#desc-group-items-loading").html("Ошибка загрузки")}})}function addDescGroupItem(){var t=$(this).closest(".desc-group"),i=t.find("#desc-group-items-select"),u=i.val()===""?-1:i.val(),r=$(".desc-item[data-id="+u+"]"),f;if($("#desc-group-items-select").val()===""||r.length){if(r.hasClass("desc-item-delete")){r.removeClass("d-none desc-item-delete");return}t.find("#desc-group-items-select+.dropdown-toggle").fadeIn(100).fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100)}else{var e=i.find("option:selected").text(),n="";n+='<div class="desc-item desc-item-add" data-id="'+u+'">';n+='    <span class="desc-item-name">'+e+'<\/span> : <span class="desc-item-value">*не указано*<\/span>';n+='    <textarea rows="3" class="form-control d-none desc-item-input"><\/textarea>';n+='    <div class="desc-item-save d-none">';n+='        <span class="btn btn-sm btn-pushy btn-outline-success fa fa-check save-desc-group-item"><\/span>';n+='        <span class="btn btn-sm btn-pushy btn-outline-danger fa fa-undo cancel-desc-group-item"><\/span>';n+="    <\/div>";n+='    <div class="desc-item-edit-delete d-inline-block">';n+='        <span class="btn btn-sm btn-pushy btn-outline-primary fa fa-edit edit-desc-group-item"><\/span>';n+='        <span class="btn btn-sm btn-pushy btn-outline-danger fa fa-close remove-desc-group-item"><\/span>';n+="    <\/div>";n+="<\/div>";f=$.parseHTML(n);t.find("#desc-group-items").append(f)}}function removeDescGroupItem(){var t=$(this),n=t.closest("div.desc-item");n.hasClass("desc-item-add")?n.remove():n.addClass("d-none desc-item-delete")}function loadImagesFromInput(){var f=$(this)[0].files.length,u=$("#image-container"),n,i,t,r;if(typeof FileReader!==undefined){for(n=0;n<f;n++)i=$(this)[0].files[n].name,t=i.substring(i.lastIndexOf(".")+1).toLowerCase(),(t==="gif"||t==="png"||t==="jpg"||t==="jpeg")&&(r=new FileReader,r.onload=function(n){var t="admin-img-thumb img-add m-2 border",i=$(".admin-img-thumb.img-primary").length===0,r;i&&(t=t+" img-primary");$("<img />",{"class":t,click:setImage,"data-id":Math.floor(Math.random()*1e7+1e7),src:n.target.result}).appendTo(u);i&&(r=$("img.admin-img-thumb.img-add"),setImage(r))},u.show(),r.readAsDataURL($(this)[0].files[n]));this.form.reset()}else alert("Браузер не поддерживает загрузку картинок.")}function editDescItem(){var n=$(this).closest(".desc-item"),t=n.find(".desc-item-value").addClass("d-none").text();n.find(".desc-item-input").removeClass("d-none").text(t);n.find(".desc-item-save").removeClass("d-none");n.find(".desc-item-edit-delete").addClass("d-none").removeClass("d-inline-block")}function saveEditDescItem(){var n=$(this).closest(".desc-item").addClass("desc-item-changed"),t=n.find(".desc-item-input").addClass("d-none").val();n.find(".desc-item-value").removeClass("d-none").text(t);n.find(".desc-item-save").addClass("d-none");n.find(".desc-item-edit-delete").removeClass("d-none").addClass("d-inline-block")}function cancelEditDescItem(){var n=$(this).closest(".desc-item");n.find(".desc-item-input").addClass("d-none");n.find(".desc-item-value").removeClass("d-none");n.find(".desc-item-save").addClass("d-none");n.find(".desc-item-edit-delete").removeClass("d-none").addClass("d-inline-block")}$("a.read-height").click(function(n){var t=getItemCountFromHeight();n.target.href=n.target.href+"?&c="+t});$("form#admin-search-form").submit(function(){var n=getItemCountFromHeight();$(this).append('<input type="hidden" name="c" value="'+n+'"/>')});$("select.admin-selector").change(function(){var n=$("form#admin-search-form");n.submit()});$("div#admin-content").on("click","img.admin-img-thumb",setImage);$("div#admin-content").on("click","#image-primary-button",setPrimaryImage);$("div#admin-content").on("click","#image-remove-button",setDeleteImage);$("div#admin-content").on("change","#file-upload-button",loadImagesFromInput);$("div#admin-content").on("click",".category-btn",loadCategoriesDropdown);$("div#admin-content").on("click",".add-cat",addCategory);$("div#admin-content").on("click",".remove-cat",removeCategory);$("div#admin-content").on("click",".desc-group-btn",loadDescGroupDropdown);$("div#admin-content").on("click",".add-desc-group",addDescGroup);$("div#admin-content").on("click",".remove-desc-group",removeDescGroup);$("div#admin-content").on("click",".desc-group-items-btn",loadDescGroupItemsDropdown);$("div#admin-content").on("click",".add-desc-group-item",addDescGroupItem);$("div#admin-content").on("click",".remove-desc-group-item",removeDescGroupItem);$("div#admin-content").on("click",".edit-desc-group-item",editDescItem);$("div#admin-content").on("click",".save-desc-group-item",saveEditDescItem);$("div#admin-content").on("click",".cancel-desc-group-item",cancelEditDescItem);$("#role-selector").change(function(){$(this).val()==="admin"?$(".admin-options").removeClass("d-none"):$(".admin-options").addClass("d-none")});$(".admin-options label").click(function(){var n=this.className.split(" "),t=n[0],i=n[1];$("."+t+"."+i+":checkbox").click()});$(".admin-options input:checkbox, .admin-options label").click(function(){var i=this.className.split(" "),t=i[0],n=i[1];t==="delete"&&this.checked===!0?($(".view."+n+":checkbox").prop("checked",!0).prop("disabled",!0),$(".edit."+n+":checkbox").prop("checked",!0).prop("disabled",!0)):t==="delete"&&this.checked===!1?($(".view."+n+":checkbox").prop("checked",!1).prop("disabled",!1),$(".edit."+n+":checkbox").prop("checked",!1).prop("disabled",!1)):t==="edit"&&this.checked===!0?$(".view."+n+":checkbox").prop("checked",!0).prop("disabled",!0):t==="edit"&&this.checked===!1&&$(".view."+n+":checkbox").prop("checked",!1).prop("disabled",!1)});